<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>RBXMX to LuaU Converter</title>
</head>
<body>
  <input type="file" id="file">
  <button id="convert">Convert</button>
  <strong id="console"></strong>
  <textarea id="code" rows="20" cols="80"></textarea>

  <script>
    const skipProps = new Set([
      "AttributesSerialize",
      "Color3uint8",
      "MaterialColors",
      "PhysicsGrid",
      "BinaryString",
      "token",
      "int",
      "float",
      "bool",
      "string",
      "ProtectedString",
      "Content",
      "CoordinateFrame",
      "PhysicalProperties"
    ]);

    function parseUDim2(text) {
      const nums = text.trim().split(/\s+/).map(Number);
      return `UDim2.new(${nums[0]}, ${nums[1]}, ${nums[2]}, ${nums[3]})`;
    }

    function parseVector2(text) {
      const nums = text.trim().split(/\s+/).map(Number);
      return `Vector2.new(${nums[0]}, ${nums[1]})`;
    }

    function parseCFrame(text) {
      const nums = text.trim().split(/\s+/).map(Number);
      return `CFrame.new(${nums.join(", ")})`;
    }

    function escape(str) {
      return str.replace(/\\/g, "\\\\").replace(/"/g, '\\"');
    }

    function parseProps(props) {
      const entries = [];
      for (const prop of props) {
        const name = prop.getAttribute("name");
        if (skipProps.has(name)) continue;
        const tag = prop.tagName;
        const value = prop.textContent.trim();
        if (tag === "string" || tag === "ProtectedString" || tag === "Content") {
          entries.push(`${name} = "${escape(value)}"`);
        } else if (tag === "bool") {
          entries.push(`${name} = ${value === "true"}`);
        } else if (tag === "int" || tag === "float" || tag === "double") {
          entries.push(`${name} = ${parseFloat(value)}`);
        } else if (tag === "UDim2") {
          entries.push(`${name} = ${parseUDim2(value)}`);
        } else if (tag === "Vector2") {
          entries.push(`${name} = ${parseVector2(value)}`);
        } else if (tag === "CFrame") {
          entries.push(`${name} = ${parseCFrame(value)}`);
        } else if (tag === "BrickColor") {
          entries.push(`${name} = BrickColor.new(${value})`);
        }
      }
      return entries;
    }

    function walk(item, indent = "") {
      const className = item.getAttribute("class");
      const name = item.getAttribute("name") || "unnamed";
      let code = `${indent}local ${name} = Instance.new("${className}")\n`;
      const props = Array.from(item.getElementsByTagName("Properties")[0]?.children || []);
      const lines = parseProps(props);
      for (const line of lines) code += `${indent}${name}.${line}\n`;

      for (const child of item.children) {
        if (child.tagName === "Item") {
          code += walk(child, indent);
          const childName = child.getAttribute("name") || "unnamed";
          code += `${indent}${childName}.Parent = ${name}\n`;
        }
      }

      return code;
    }

    document.getElementById("convert").addEventListener("click", () => {
      const fileInput = document.getElementById("file");
      const consoleEl = document.getElementById("console");
      const codeEl = document.getElementById("code");
      if (!fileInput.files[0]) {
        consoleEl.textContent = "No file selected.";
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const parser = new DOMParser();
        const xml = parser.parseFromString(e.target.result, "application/xml");
        const rootItems = xml.querySelectorAll("Item");
        let luaCode = "";
        rootItems.forEach(item => luaCode += walk(item));
        codeEl.value = luaCode;
        consoleEl.textContent = "Success!";
      };
      reader.readAsText(fileInput.files[0]);
    });
  </script>
</body>
</html>
