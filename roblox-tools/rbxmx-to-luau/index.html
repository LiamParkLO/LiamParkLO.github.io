<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />
<title>Rojo GitHub Repo to LuaU Converter</title>
<style>
  body { font-family: sans-serif; padding: 1em; max-width: 800px; margin: auto; }
  input, button { margin: 0.5em 0; padding: 0.5em; width: 100%; }
  textarea { width: 100%; height: 400px; margin-top: 1em; font-family: monospace; }
  #console { color: red; font-weight: bold; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>

<h1>Rojo GitHub Repo to LuaU Converter</h1>
<input type="text" id="user" placeholder="GitHub user or org" />
<input type="text" id="repo" placeholder="GitHub repo name" />
<button id="convert">Convert Repo</button>
<div id="console"></div>
<textarea id="output" readonly></textarea>

<script>
  async function fetchRepoZip(user, repo) {
    const url = `https://github.com/${user}/${repo}/archive/refs/heads/main.zip`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Failed to fetch repo ZIP: ${res.status}`);
    const blob = await res.blob();
    const arrayBuffer = await blob.arrayBuffer();
    return arrayBuffer;
  }

  // Recursively build a nested object { filename: content or folder: { ... } }
  async function parseZip(zipData) {
    const zip = await JSZip.loadAsync(zipData);
    const repo = {};

    // GitHub ZIPs have a root folder named `${repo}-${branch}/`
    const rootFolder = Object.keys(zip.files)[0].split('/')[0];

    for (const [path, file] of Object.entries(zip.files)) {
      if (file.dir) continue;
      // Remove rootFolder prefix from path
      if (!path.startsWith(rootFolder + "/")) continue;
      const relativePath = path.slice(rootFolder.length + 1);

      const parts = relativePath.split('/');
      let current = repo;
      for (let i = 0; i < parts.length; i++) {
        const part = parts[i];
        if (i === parts.length - 1) {
          // File: load content as text
          current[part] = await file.async("text");
        } else {
          // Folder
          if (!current[part]) current[part] = {};
          current = current[part];
        }
      }
    }

    return repo;
  }

  // Validate that all files mentioned in default.project.json exist in repo object
  function validateProjectTree(tree, repo, pathPrefix = "") {
    for (const key in tree) {
      if (key === "$className" || key === "$properties" || key === "$ignoreUnknownInstances") continue;

      const entry = tree[key];
      if (typeof entry === "object") {
        if ("$path" in entry) {
          const filePath = entry["$path"];
          if (!checkFileExists(repo, filePath)) {
            throw new Error(`Missing file: ${pathPrefix}${filePath}`);
          }
        } else {
          validateProjectTree(entry, repo, pathPrefix);
        }
      }
    }
  }

  // Helper: check if a file path exists in repo (support nested folders)
  function checkFileExists(repo, filePath) {
    const parts = filePath.split('/');
    let current = repo;
    for (const part of parts) {
      if (!current[part]) return false;
      current = current[part];
    }
    return typeof current === "string";
  }

  // Your existing rbxmx to luau converter goes here (for brevity, simplified)
  // For demo, we will just output file names and paths instead of full conversion
  function convertRepoToLuaU(repo, projectJson) {
    // Example: just print all rbxmx files paths found in the project tree
    const paths = [];

    function collectPaths(tree) {
      for (const key in tree) {
        if (key === "$className" || key === "$properties" || key === "$ignoreUnknownInstances") continue;
        const entry = tree[key];
        if (typeof entry === "object") {
          if ("$path" in entry) {
            paths.push(entry["$path"]);
          } else {
            collectPaths(entry);
          }
        }
      }
    }

    collectPaths(projectJson.tree);

    // Print file names found
    return "-- Files referenced in project:\n" + paths.map(p => `"${p}"`).join("\n");
  }

  document.getElementById("convert").addEventListener("click", async () => {
    const user = document.getElementById("user").value.trim();
    const repo = document.getElementById("repo").value.trim();
    const output = document.getElementById("output");
    const consoleOut = document.getElementById("console");

    consoleOut.textContent = "";
    output.value = "";

    if (!user || !repo) {
      consoleOut.textContent = "Please enter both GitHub user and repo.";
      return;
    }

    try {
      consoleOut.textContent = "Downloading repo ZIP...";
      const zipData = await fetchRepoZip(user, repo);

      consoleOut.textContent = "Parsing ZIP files...";
      const repoObj = await parseZip(zipData);

      if (!repoObj["default.project.json"]) {
        throw new Error("default.project.json not found in root of repo.");
      }

      consoleOut.textContent = "Parsing default.project.json...";
      const projectJson = JSON.parse(repoObj["default.project.json"]);

      consoleOut.textContent = "Validating project tree files...";
      validateProjectTree(projectJson.tree, repoObj);

      consoleOut.textContent = "Converting .rbxmx files to LuaU...";
      const luauCode = convertRepoToLuaU(repoObj, projectJson);

      output.value = luauCode;
      consoleOut.textContent = "Conversion complete.";

    } catch (err) {
      consoleOut.textContent = "Error: " + err.message;
    }
  });
</script>
</body>
</html>
