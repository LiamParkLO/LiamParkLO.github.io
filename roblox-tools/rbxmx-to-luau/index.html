<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RBXMX to LuaU Converter</title>
<style>
  body { font-family: monospace; padding: 20px; }
  #console { color: red; margin-bottom: 10px; display: block; }
  #code { width: 100%; height: 300px; }
</style>
</head>
<body>

<input type="file" id="file" />
<button id="convert">Convert</button>
<strong id="console"></strong>
<textarea id="code" readonly></textarea>

<script>
document.getElementById("convert").addEventListener("click", async () => {
  const fileInput = document.getElementById("file");
  const consoleEl = document.getElementById("console");
  const codeEl = document.getElementById("code");
  consoleEl.textContent = "";
  codeEl.value = "";

  try {
    const file = fileInput.files[0];
    if (!file) throw new Error("No file selected.");

    const text = await file.text();

    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(text, "application/xml");

    if (xmlDoc.querySelector("parsererror")) {
      throw new Error("Invalid XML file.");
    }

    function parseProperty(propEl) {
      const type = propEl.tagName;
      const textContent = propEl.textContent.trim();

      switch (type) {
        case "bool":
          return textContent === "true" ? "true" : "false";
        case "int":
        case "float":
          return textContent;
        case "string":
          return `"${textContent.replace(/"/g, '\\"')}"`;
        case "Vector2": {
          const x = propEl.querySelector("X")?.textContent || "0";
          const y = propEl.querySelector("Y")?.textContent || "0";
          return `Vector2.new(${x}, ${y})`;
        }
        case "Vector3": {
          const x = propEl.querySelector("X")?.textContent || "0";
          const y = propEl.querySelector("Y")?.textContent || "0";
          const z = propEl.querySelector("Z")?.textContent || "0";
          return `Vector3.new(${x}, ${y}, ${z})`;
        }
        case "UDim2": {
          const X = propEl.querySelector("X");
          const Y = propEl.querySelector("Y");
          return `UDim2.new(${X.querySelector("Scale")?.textContent || 0}, ${X.querySelector("Offset")?.textContent || 0}, ${Y.querySelector("Scale")?.textContent || 0}, ${Y.querySelector("Offset")?.textContent || 0})`;
        }
        case "CFrame": {
          const keys = ["X", "Y", "Z", "R00", "R01", "R02", "R10", "R11", "R12", "R20", "R21", "R22"];
          const vals = keys.map(k => propEl.querySelector(k)?.textContent || "0");
          return `CFrame.new(${vals.join(", ")})`;
        }
        case "BrickColor": {
          return `BrickColor.new(${textContent})`;
        }
        default:
          return `"${textContent.replace(/"/g, '\\"')}"`;
      }
    }

    let id = 0;
    function getUniqueName(base) {
      return `${base}_${id++}`;
    }

    function convertInstanceToLua(itemEl, indent = "") {
      const className = itemEl.getAttribute("class");
      if (!className) return "";

      const varName = getUniqueName(className.toLowerCase());
      let lua = `${indent}local ${varName} = Instance.new("${className}")\n`;

      const propertiesEl = itemEl.querySelector(":scope > Properties");

      const skipProps = new Set(["BinaryString", "PhysicalProperties", "Content", "ProtectedString"]);

      if (propertiesEl) {
        for (const propEl of propertiesEl.children) {
          if (propEl.tagName === "Name") continue;

          const propName = propEl.getAttribute("name");
          if (!propName) continue;

          if (skipProps.has(propName)) {
            lua += `${indent}-- Skipped property ${propName} (complex data)\n`;
            continue;
          }

          const value = parseProperty(propEl);
          if (value !== undefined) {
            lua += `${indent}${varName}.${propName} = ${value}\n`;
          }
        }
      }

      const childrenEls = Array.from(itemEl.querySelectorAll(":scope > Item"));
      for (const child of childrenEls) {
        lua += convertInstanceToLua(child, indent);
        const childVarName = `${child.getAttribute("class").toLowerCase()}_${id - 1}`;
        lua += `${indent}${childVarName}.Parent = ${varName}\n`;
      }

      return lua;
    }

    const rootItem = xmlDoc.querySelector("roblox > Item");
    if (!rootItem) throw new Error("No root Item found.");

    const luaCode = convertInstanceToLua(rootItem);
    codeEl.value = luaCode;
  } catch (e) {
    consoleEl.textContent = "Error: " + e.message;
    console.error(e);
  }
});
</script>

</body>
</html>
