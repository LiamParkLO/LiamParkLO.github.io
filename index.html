<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Babylon.js Platformer with Gamepad Support and Camera Attachment</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { width: 100%; height: 100% }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);

        const createScene = () => {
            const scene = new BABYLON.Scene(engine);

            // Create the player (a simple box)
            const player = BABYLON.MeshBuilder.CreateBox("player", {size: 1}, scene);
            player.position = new BABYLON.Vector3(0, 1, 0); // Initial position above the ground
            player.checkCollisions = true;

            // Enable gravity and collisions
            scene.gravity = new BABYLON.Vector3(0, -0.2, 0);
            scene.collisionsEnabled = true;

            // Set the player to collide with the ground and platform
            player.ellipsoid = new BABYLON.Vector3(0.5, 1, 0.5);
            player.ellipsoidOffset = new BABYLON.Vector3(0, 0, 0);

            // Create a camera and attach it to the player
            const camera = new BABYLON.FollowCamera("camera", player.position, scene);
            camera.radius = 10; // Distance from player
            camera.heightOffset = 5; // Height offset
            camera.rotationOffset = 0; // Camera's rotation offset
            camera.attachControl(canvas, true);

            // Create a light
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);

            // Create the ground
            const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 20, height: 20}, scene);
            ground.position.y = -2;

            // Create a platform
            const platform = BABYLON.MeshBuilder.CreateBox("platform", {height: 1, width: 10, depth: 1}, scene);
            platform.position = new BABYLON.Vector3(0, -1, 0);

            // Create simple movement and jumping controls
            const moveSpeed = 0.1;
            const jumpStrength = 2;
            let jumping = false;
            let moveDirection = new BABYLON.Vector3(0, 0, 0);

            // Gamepad support with deadzone
            let gamepad = null;

            const handleGamepadInputs = () => {
                const gamepads = navigator.getGamepads();
                for (let i = 0; i < gamepads.length; i++) {
                    if (gamepads[i]) {
                        gamepad = gamepads[i];
                        break;
                    }
                }

                if (gamepad) {
                    // Left Thumbstick for player movement with deadzone
                    let leftThumbX = gamepad.axes[0]; // Left horizontal axis
                    let leftThumbY = gamepad.axes[1]; // Left vertical axis

                    // Apply deadzone (0.3)
                    if (Math.abs(leftThumbX) < 0.3) leftThumbX = 0;
                    if (Math.abs(leftThumbY) < 0.3) leftThumbY = 0;

                    // Right Thumbstick for camera rotation with deadzone
                    let rightThumbX = gamepad.axes[2]; // Right horizontal axis
                    let rightThumbY = gamepad.axes[3]; // Right vertical axis

                    // Apply deadzone (0.3)
                    if (Math.abs(rightThumbX) < 0.3) rightThumbX = 0;
                    if (Math.abs(rightThumbY) < 0.3) rightThumbY = 0;

                    // Rotate the player based on the right thumbstick (rotation around Y-axis)
                    player.rotation.y += rightThumbX * 0.05; // Rotate player horizontally

                    // Calculate movement relative to the camera's orientation
                    const forwardDirection = camera.getForwardVector();
                    const rightDirection = camera.getRightVector();

                    moveDirection.x = leftThumbX * moveSpeed;
                    moveDirection.z = leftThumbY * moveSpeed;

                    // Apply the movement relative to the camera
                    player.position.x += moveDirection.x * forwardDirection.x + moveDirection.z * rightDirection.x;
                    player.position.z += moveDirection.x * forwardDirection.z + moveDirection.z * rightDirection.z;

                    // A button (for Xbox controller, it's button 0) for jump
                    if (gamepad.buttons[0].pressed && !jumping) { // A button
                        jumping = true;
                        player.applyImpulse(new BABYLON.Vector3(0, jumpStrength, 0), player.getAbsolutePosition());
                    }
                }
            };

            // Update the player's position based on inputs
            scene.registerBeforeRender(() => {
                handleGamepadInputs();

                // Apply gravity
                if (player.position.y > 0) {
                    player.position.y += scene.gravity.y;
                } else if (player.position.y <= 0) {
                    jumping = false;
                    player.position.y = 0; // Make sure player is on the ground
                }

                // Keep the player within the bounds
                if (player.position.x > 10) {
                    player.position.x = 10;
                } else if (player.position.x < -10) {
                    player.position.x = -10;
                }

                if (player.position.z > 10) {
                    player.position.z = 10;
                } else if (player.position.z < -10) {
                    player.position.z = -10;
                }
            });

            return scene;
        };

        const scene = createScene();
        engine.runRenderLoop(() => {
            scene.render();
        });

        window.addEventListener("resize", () => {
            engine.resize();
        });
    </script>
</body>
</html>
