<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Babylon.js Platformer with Gamepad Support</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { width: 100%; height: 100% }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);

        const createScene = () => {
            const scene = new BABYLON.Scene(engine);

            // Create a camera
            const camera = new BABYLON.ArcRotateCamera("camera", Math.PI / 2, Math.PI / 3, 10, BABYLON.Vector3.Zero(), scene);
            camera.attachControl(canvas, true);
            
            // Create a light
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
            
            // Create the ground
            const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 20, height: 20}, scene);
            ground.position.y = -2;

            // Create a platform
            const platform = BABYLON.MeshBuilder.CreateBox("platform", {height: 1, width: 10, depth: 1}, scene);
            platform.position = new BABYLON.Vector3(0, -1, 0);
            
            // Create the player (a simple box)
            const player = BABYLON.MeshBuilder.CreateBox("player", {size: 1}, scene);
            player.position = new BABYLON.Vector3(0, 0, 0);
            player.checkCollisions = true;

            // Enable gravity and collisions
            scene.gravity = new BABYLON.Vector3(0, -0.2, 0);
            scene.collisionsEnabled = true;

            // Set the player to collide with the ground and platform
            player.ellipsoid = new BABYLON.Vector3(0.5, 1, 0.5);
            player.ellipsoidOffset = new BABYLON.Vector3(0, 0, 0);
            
            // Create simple movement and jumping controls
            const moveSpeed = 0.1;
            let jumping = false;
            let moveDirection = new BABYLON.Vector3(0, 0, 0);

            // Gamepad support
            let gamepad = null;

            const handleGamepadInputs = () => {
                const gamepads = navigator.getGamepads();
                for (let i = 0; i < gamepads.length; i++) {
                    if (gamepads[i]) {
                        gamepad = gamepads[i];
                        break;
                    }
                }

                if (gamepad) {
                    // Left Thumbstick for player movement (X and Y axis)
                    const leftThumbX = gamepad.axes[0]; // Left horizontal axis
                    const leftThumbY = gamepad.axes[1]; // Left vertical axis
                    moveDirection.x = leftThumbX * moveSpeed;
                    moveDirection.z = leftThumbY * moveSpeed;

                    // Right Thumbstick for camera rotation
                    const rightThumbX = gamepad.axes[2]; // Right horizontal axis
                    const rightThumbY = gamepad.axes[3]; // Right vertical axis
                    camera.alpha += rightThumbX * 0.05; // Rotate camera horizontally
                    camera.beta += rightThumbY * 0.05;  // Rotate camera vertically

                    // A button (for Xbox controller, it's button 0) for jump
                    if (gamepad.buttons[0].pressed && !jumping) { // A button
                        jumping = true;
                        player.applyImpulse(new BABYLON.Vector3(0, 2, 0), player.getAbsolutePosition());
                    }
                }
            };

            // Update the player's position based on inputs
            scene.registerBeforeRender(() => {
                handleGamepadInputs();

                if (!player.intersectsMesh(ground, false) && !player.intersectsMesh(platform, false)) {
                    if (!jumping) {
                        player.position.y -= 0.05;
                    }
                }

                // Apply gravity
                if (player.position.y > 0) {
                    player.position.y += scene.gravity.y;
                } else if (player.position.y <= 0) {
                    jumping = false;
                    player.position.y = 0;
                }

                // Move player based on gamepad input
                player.position.x += moveDirection.x;
                player.position.z += moveDirection.z;

                // Keep the player within the bounds
                if (player.position.x > 10) {
                    player.position.x = 10;
                } else if (player.position.x < -10) {
                    player.position.x = -10;
                }

                if (player.position.z > 10) {
                    player.position.z = 10;
                } else if (player.position.z < -10) {
                    player.position.z = -10;
                }
            });

            return scene;
        };

        const scene = createScene();
        engine.runRenderLoop(() => {
            scene.render();
        });

        window.addEventListener("resize", () => {
            engine.resize();
        });
    </script>
</body>
</html>
